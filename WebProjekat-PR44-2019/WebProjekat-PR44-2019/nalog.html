<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Nalog</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="nalog.css">
    <script src="../../Scripts/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
    <script>
        $(document).ready(function () {
            var komentari = [];
            var id_list = [];

            if (localStorage.getItem("user") === "GOST") {
                $(location).attr('href', 'login.html');
            }

            var korisnickoIme = localStorage.getItem("user");
            $("#korisnik").html(localStorage.getItem("user"));
            $("#nalog").show();
            $("#odjavaBtn").click(function () {
                localStorage.setItem("user", "GOST")
                $(location).attr('href', 'login.html');
            });

            $.ajax({
                type: 'GET',
                url: '/api/Login/',
                data: {
                    korisnickoIme
                },
                success: function (data) {

                    komentari = data;
                    UpisiPodatkeUPolja(komentari, id_list);
                }
            })
            $(document).on("click", "#izmeniBtn", function () {

                let pol;
                if ($('#pol').find(":selected").text() === "Muški")
                    pol = "Muski";
                else
                    pol = "Zenski";

                let korisnik = {
                    KorisnickoIme: `${$('#username').val()}`,
                    Lozinka: `${$('#sifra').val()}`,
                    Ime: `${$('#ime').val()}`,
                    Prezime: `${$('#prezime').val()}`,
                    DatumRodjenja: `${$('#datum').val()}`,
                    Email: `${$('#email').val()}`,
                    Pol: `${pol}`
                };

                if (!CheckRegistrationInput(korisnik))
                    return;

                var initial = korisnik.DatumRodjenja.split('-');
                korisnik.DatumRodjenja = [initial[2], initial[1], initial[0]].join('/');


                $.ajax({
                    type: 'PUT',
                    url: '/api/Login',
                    data: JSON.stringify(korisnik),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        alert("Uspesno izmenjen korisnik '" + korisnik.KorisnickoIme + "'!");
                        $(location).attr('href', 'nalog.html');
                    },
                    error: function (data) {
                        alert("Izmena nije moguća. Proverite unešene podatke.");
                    }
                })
            });

            $(document).on("click", "#odobriBtn", function () {

                var trenuntiRed = $(this).closest("tr");
                var col1 = trenuntiRed.find("td:eq(0)").text();
                var col2 = trenuntiRed.find("td:eq(1)").text();
                var col3 = trenuntiRed.find("td:eq(2)").text();
                var col4 = trenuntiRed.find("td:eq(3)").text();
                let komentar = {
                    FitnesCentar: `${col2}`,
                    Ocena: `${$('#ocena').find(":selected").text()}`,
                    Posetilac: `${col3}`,
                    Tekst: `${col4}`,
                    Id: `${id_list[col1 - 1]}`,
                    Status: `${1}`
                };
                $.ajax({
                    type: 'PUT',
                    url: '/api/Komentar',
                    data: JSON.stringify(komentar),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    complete: function (data) {
                        $(location).attr('href', 'nalog.html');
                    }
                })
            });

            $(document).on("click", "#odbaciBtn", function () {

                var trenuntiRed = $(this).closest("tr");
                var col1 = trenuntiRed.find("td:eq(0)").text();
                var col2 = trenuntiRed.find("td:eq(1)").text();
                var col3 = trenuntiRed.find("td:eq(2)").text();
                var col4 = trenuntiRed.find("td:eq(3)").text();
                let komentar = {
                    FitnesCentar: `${col2}`,
                    Ocena: `${$('#ocena').find(":selected").text()}`,
                    Posetilac: `${col3}`,
                    Tekst: `${col4}`,
                    Id: `${id_list[col1 - 1]}`,
                    Status: `${2}`
                };
                $.ajax({
                    type: 'PUT',
                    url: '/api/Komentar',
                    data: JSON.stringify(komentar),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    complete: function (data) {
                        $(location).attr('href', 'nalog.html');
                    }
                })
            });
        });

        function UpisiPodatkeUPolja(korisnik, id_list) {

            let tipUloge = "";
            if (korisnik.Uloga == 0) {
                tipUloge = "POSETILAC";
                $("#obradaTable").hide();
                $("#odbijeniTable").hide();
                $("#odbijeniKom").hide();
            } else if (korisnik.Uloga == 1) {
                tipUloge = "TRENER";
                $("#obradaTable").hide();
                $("#odbijeniTable").hide();
                $("#odbijeniKom").hide();
            } else if (korisnik.Uloga == 2) {
                tipUloge = "VLASNIK";
                $("#obradaTable").show();
                $("#odbijeniTable").show();
                $("#odbijeniKom").show();
                $.ajax({
                    type: 'GET',
                    url: '/api/Komentar?option=' + 1 + '&username=' + localStorage.getItem("user"),
                    success: function (data1) {
                        UpisiKomentareUPolja(data1, id_list);
                        $.ajax({
                            type: 'GET',
                            url: '/api/Komentar?option=' + 2 + '&username=' + localStorage.getItem("user"),
                            success: function (data2) {
                                UpisiOdbijeneKomentare(data2);
                            }

                        })
                    }

                });
               
            }
            var initial = korisnik.DatumRodjenja.split('/');
            var toInput = [initial[2], initial[1], initial[0]].join('-');

            $("#username").val(korisnik.KorisnickoIme);
            $("#sifra").val(korisnik.Lozinka);
            $("#ime").val(korisnik.Ime);
            $("#prezime").val(korisnik.Prezime);
            $("#email").val(korisnik.Email);
            $("#datum").val(toInput);
            $("#uloga").val(tipUloge);

            let pol;
            if (korisnik.Pol === "Muski")
                pol = "M";
            else
                pol = "Z";
            $("#pol").val(pol).change();
        }
        function UpisiKomentareUPolja(komentari, id_list) {
            var id = 1;
            var temp = komentari;
            if (temp.length === 0) {
                $("#obradaTable").append("<tr><td colspan=\"6\">Nema komentara za obradu!</td>/tr>");
                return;
            }
            for (let key in temp) {
                $("#obradaTable").append("<tr><td>" + id + "</td><td>" + temp[key].FitnesCentar + "</td>"
                    + "<td>" + temp[key].Posetilac + "</td>"
                    + "<td>" + temp[key].Ocena + "</td>"
                    + "<td id=\"tekstPolje\">" + temp[key].Tekst + "</td>"
                    + "<td colspan=\"2\"> <button id=\"odobriBtn\">ODOBRI</button>"
                    + "<button id=\"odbaciBtn\" >ODBACI</button></td>"
                    + "</tr>");
                id_list.push(temp[key].Id);
                id = id + 1;
            }
        }
        function UpisiOdbijeneKomentare(komentari) {
            var id = 1;
            var temp = komentari;
            if (temp.length === 0) {
                $("#odbijeniTable").append("<tr><td colspan=\"5\">Nema odbijenih komentara!</td>/tr>");
                return;
            }
            for (let key in temp) {
                $("#odbijeniTable").append("<tr><td>" + id + "</td><td>" + temp[key].FitnesCentar + "</td>"
                    + "<td>" + temp[key].Posetilac + "</td>"
                    + "<td>" + temp[key].Ocena + "</td>"
                    + "<td id=\"tekstPolje\">" + temp[key].Tekst + "</td>"
                    + "</tr>");
                id = id + 1;
            }
        }

        function CheckRegistrationInput(korisnik) {
            var boolean = true

            if (korisnik.Lozinka === null || korisnik.Lozinka.length === 0) {
                $("#sifra").css("background-color", "#FF8484");
                boolean = false
            }
            else {
                $("#sifra").css("background-color", "#d1d1d5");
            }
            if (korisnik.Ime === null || korisnik.Ime.length === 0) {
                $("#ime").css("background-color", "#FF8484");
                boolean = false
            } else {
                $("#ime").css("background-color", "#d1d1d5");
            }
            if (korisnik.Prezime === null || korisnik.Prezime.length === 0) {
                $("#prezime").css("background-color", "#FF8484");
                boolean = false
            } else {
                $("#prezime").css("background-color", "#d1d1d5");
            }
            if (korisnik.Email === null || korisnik.Email.length === 0) {
                $("#email").css("background-color", "#FF8484");
                boolean = false
            } else {
                var mail_format = /\S+@\S+\.\S+/;
                if (!(mail_format.test(korisnik.Email))) {
                    $("#email").css("background-color", "#FF8484");
                    boolean = false;
                } else {
                    $("#email").css("background-color", "#d1d1d5");
                }
            }
            if (korisnik.DatumRodjenja.length == 0) {
                $("#datum").css("background-color", "#FF8484");
                boolean = false
            } else {
                $("#datum").css("background-color", "#d1d1d5");
            }

            return boolean;
        }
    </script>
    <div class="header">
        <span id="naslov"><span id="prvo">F</span>itnes <span id="drugo">C</span>entri</span>
        <span class="navbar">
            <a href="index.html">POČETNA</a>
            <a href="login.html">PRIJAVA</a>
            <a href="registration.html">REGISTRACIJA</a>
            <a href="nalog.html">NALOG</a>
        </span>
        <span id="welcome">Dobrodošli, <span id="korisnik">GOST</span> !</span>
        <span><button id="odjavaBtn">ODJAVA</button></span>
    </div>
    <hr id="hr">
    <br>
    <br>

    <table id="nalogTable">
        <caption id="nalogCaption">INFORMACIJE O KORISNIKU</caption>
        <tr>
            <td class="polje">Korisničko ime: </td>
            <td><input type="text" id="username" readonly></td>
            <td class="polje">Lozinka: </td>
            <td><input type="password" id="sifra"></td>
        </tr>
        <tr>
            <td class="polje">Ime: </td>
            <td><input type="text" id="ime"></td>
            <td class="polje">Prezime: </td>
            <td><input type="text" id="prezime"></td>

        </tr>
        <tr>
            <td class="polje">E-mail: </td>
            <td><input type="text" id="email"></td>
            <td class="polje">Datum rođenja: </td>
            <td><input type="date" id="datum" value=""></td>
        </tr>
        <tr>
            <td class="polje">Uloga: </td>
            <td><input type="text" id="uloga" readonly></td>
            <td class="polje">Pol: </td>
            <td>
                <select name="pol" id="pol">
                    <option value="M">Muški</option>
                    <option value="Z">Ženski</option>
                </select>
            </td>
        </tr>
        <tr>
            <td colspan="4">
                <button id="izmeniBtn">Izmeni</button>
            </td>
        </tr>
    </table>
    <br><br><br><br><br>
    <table id="obradaTable" hidden>
        <tr>
            <th id="id"></th>
            <th>Naziv fitnes centra</th>
            <th>Posetilac</th>
            <th>Ocena</th>
            <th>Tekst</th>
            <th></th>
        </tr>
    </table>
    <br><br><br><br><br>
    <div id="odbijeniKom" hidden>Odbijeni komentari</div>
    <table id="odbijeniTable" hidden>
        <tr>
            <th id="id"></th>
            <th>Naziv fitnes centra</th>
            <th>Posetilac</th>
            <th>Ocena</th>
            <th>Tekst</th>
        </tr>
    </table>
    <br><br><br><br><br>
</body>
</html>